
#include <check.h>

#include "../src/convert.h"
#include "../src/data/cga.h"
#include "../src/data/bmp.h"

static const uint8_t gc_test_cga_16_16_4[84] = {
   'C', 'G',
   0x01, 0x00, /* Version      1 */
   0x10, 0x00, /* Width:      16 */
   0x10, 0x00, /* Height:     16 */
   0x02, 0x00, /* BPP:         2 */
   0x14, 0x00, /* Plane1 Ofs: 20 */
   0x20, 0x00, /* Plane1 Siz: 32 */
   0x34, 0x00, /* Plane2 Ofs: 52 */
   0x20, 0x00, /* Plane2 Siz: 32 */
   0x01, 0x00, /* Palette:     1 */

   /* End Header */
   
   /* Plane 1 */
   0xff, 0xff, 0xff, 0xff, /* 0 Offset: 20 */
   0xff, 0x00, 0x00, 0xff, /* 1 */
   0x0f, 0x00, 0x00, 0xf0, /* 2 */
   0x0f, 0x00, 0x00, 0xf0, /* 3 */
   0x0f, 0xf0, 0x0f, 0xf0, /* 4 */
   0x0f, 0x00, 0x00, 0xf0, /* 5 */
   0x0f, 0x00, 0x00, 0xf0, /* 6 */
   0xff, 0xff, 0xff, 0xff, /* 7 */

   /* Plane 2 */
   0xff, 0xff, 0xff, 0xff, /* 0 Offset: 52 */
   0x0f, 0x00, 0x00, 0xf0, /* 1 */ 
   0x0f, 0x00, 0x00, 0xf0, /* 2 */
   0x0f, 0xf0, 0x0f, 0xf0, /* 3 */
   0x0f, 0x00, 0x00, 0xf0, /* 4 */
   0x0f, 0x00, 0x00, 0xf0, /* 5 */
   0x0f, 0x00, 0x00, 0xf0, /* 6 */
   0xff, 0xff, 0xff, 0xff, /* 7 */

};

static const uint8_t gc_test_grid_16_16_4_data[256] = {
   0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, /* 3333333333333333 */
   0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, /* 00 Even 00 */

   0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, /* 3333333333333333 */
   0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, /* 01 Odd  00 */

   0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 3300000000000033 */
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, /* 02 Even 01 */

   0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 3300000000000033 */
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, /* 03 Odd  01 */

   0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 3300000000000033 */
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, /* 04 Even 02 */

   0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 3300000000000033 */
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, /* 05 Odd  02 */

   0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 3300000000000033 */
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, /* 06 Even 03 */

   0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, /* 3300000330000033 */
   0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, /* 07 Odd  03 */

   0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, /* 3300000330000033 */
   0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, /* 08 Even 04 */

   0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 3300000000000033 */
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, /* 09 Odd  04 */

   0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 3300000000000033 */
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, /* 10 Even 05 */

   0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 3300000000000033 */
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, /* 11 Odd  05 */

   0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 3300000000000033 */
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, /* 12 Even 06 */

   0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 3300000000000033 */
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, /* 13 Odd  06 */

   0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, /* 3333333333333333 */
   0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, /* 14 Even 07 */

   0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, /* 3333333333333333 */
   0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, /* 15 Odd  07 */
};

static const struct CONVERT_GRID gc_test_grid_16_16_4 = {
   16,
   16,
   4,
   256,
   &gc_test_grid_16_16_4_data
};

void buffer_printf( uint8_t* buffer, int start, int end ) {
   int column_idx = 1,
      i = 0;

   for( i = start ; end > i ; i++ ) {
      printf( "0x%02x ", buffer[i] );

      if( 0 == column_idx % 10 ) {
         printf( "\n" );
      }
      column_idx++;
   }

   printf( "\n\n" );
}

START_TEST( check_data_cga_read ) {
   struct CONVERT_GRID* grid = NULL;
   struct CONVERT_OPTIONS options;

   memset( &options, '\0', sizeof( struct CONVERT_OPTIONS ) );
   options.cga_use_header = 1;

   grid = cga_read( (const uint8_t*)&gc_test_cga_16_16_4, 84, &options );

   ck_assert_int_eq( 16, grid->sz_x );
   ck_assert_int_eq( 16, grid->sz_y );
   ck_assert_int_eq( 256, grid->data_sz );
   
   ck_assert_int_eq( gc_test_grid_16_16_4_data[_i], grid->data[_i] );
}
END_TEST

START_TEST( check_data_cga_write ) {
   struct CONVERT_GRID* grid = NULL;
   struct CONVERT_OPTIONS options;
   uint8_t buffer[1024];
   struct CGA_HEADER* cga_header = (struct CGA_HEADER*)buffer;

   memset( &buffer, '\0', 1024 );
   memset( &options, '\0', sizeof( struct CONVERT_OPTIONS ) );
   options.cga_use_header = 1;
   options.bpp = 2;

   grid = bmp_read_file( "assets/test_16_16_4.bmp", &options );

   cga_write( &buffer, 1024, grid, &options );

   ck_assert_int_eq( 16, cga_header->width );
   ck_assert_int_eq( 16, cga_header->height );
   ck_assert_int_eq( 2, cga_header->bpp );
   ck_assert_int_eq( 1, cga_header->version );
}
END_TEST

Suite* data_suite( void ) {
   Suite* s;
   TCase* tc_core;

   s = suite_create( "data" );

   /* Core test case */
   tc_core = tcase_create( "Core" );

   tcase_add_loop_test( tc_core, check_data_cga_read, 0, 256 );
   tcase_add_test( tc_core, check_data_cga_read );
   tcase_add_test( tc_core, check_data_cga_write );

   suite_add_tcase( s, tc_core );

   return s;
}

